---
title: "Identificación de patrones en datos de aceleración obtenidos mediante el celular"
subtitle: "Análisis de patrones de movimiento"
author: 
  - name: Sofía Duque Rendón 
  - name: Melany Franco Marin 
  - name: Juan David Trejos
  - name: Miguel Ángel Vargas Valencia
date: last-modified
date-format: full
lang: es
format: 
  pdf:
    toc: true
editor: source
execute: 
  echo: false
  warning: false
---

```{r}
rm(list = ls())
```

```{r}
library(tidyverse)
library(gridExtra)
library(patchwork)
library(cowplot)
```

# Introducción

# Descripción y recolección de los datos

```{r}
datosSofia <- read.csv("sensores/GrabacionSofia.csv")
datosMelany <- read.csv("sensores/GrabacionMelany.csv")
datosJuan <- read.csv("sensores/GrabacionJuanDavid.csv")
datosMiguel <- read.csv("sensores/GrabacionMiguel.csv")

```

Los datos fueron recolectados utilizando la aplicación *Arduino Science Journal*, que emplea los sensores del teléfono móvil para registrar las aceleraciones en los ejes X, Y y Z. Para este análisis se realizaron cuatro mediciones, de las cuales dos se llevaron a cabo mientras se ejecutaban las mismas actividades.

## timestamp

Marca temporal que indica el momento exacto en que fue tomada cada medición. Se encuentra en formato de milisegundos desde la época UNIX (1 de enero de 1970).

## AccX

Aceleración medida en el eje **X** del dispositivo móvil. Representa la fuerza de aceleración detectada en la dirección horizontal (izquierda-derecha) y se mide en metros por segundo al cuadrado (m/s²).

## AccY

Aceleración medida en el eje **Y** del dispositivo móvil. Representa la fuerza de aceleración en la dirección vertical (arriba-abajo), también en unidades de m/s².

## AccZ

Aceleración medida en el eje **Z** del dispositivo móvil. Corresponde a la aceleración perpendicular a la pantalla del dispositivo (profundidad), medida igualmente en m/s².

```{r}
datosSofia <- datosMelany |> 
  mutate(fecha = as.POSIXct(timestamp/1000),
         AccT = sqrt(AccX^2 + AccY^2 + AccZ^2))

datosMelany <- datosMelany |> 
  mutate(fecha = as.POSIXct(timestamp/1000),
         AccT = sqrt(AccX^2 + AccY^2 + AccZ^2))

datosJuan <- datosJuan |> 
  mutate(fecha = as.POSIXct(timestamp/1000),
         AccT = sqrt(AccX^2 + AccY^2 + AccZ^2))

datosMiguel <- datosMiguel |> 
  mutate(fecha = as.POSIXct(timestamp/1000),
         AccT = sqrt(AccX^2 + AccY^2 + AccZ^2))
```

\newpage

# Gráficas exploratorias de X, Y y Z

```{r}
gxSofia <- ggplot(datosSofia, aes(fecha, AccX)) +
  geom_line()
gySofia <- ggplot(datosSofia, aes(fecha, AccX)) +
  geom_line()
gzSofia <- ggplot(datosSofia, aes(fecha, AccX)) +
  geom_line()

gxMelany <- ggplot(datosMelany, aes(fecha, AccX)) +
  geom_line()
gyMelany <- ggplot(datosMelany, aes(fecha, AccX)) +
  geom_line()
gzMelany <- ggplot(datosMelany, aes(fecha, AccX)) +
  geom_line()

gxJuan <- ggplot(datosJuan, aes(fecha, AccX)) +
  geom_line()
gyJuan <- ggplot(datosJuan, aes(fecha, AccX)) +
  geom_line()
gzJuan <- ggplot(datosJuan, aes(fecha, AccX)) +
  geom_line()

gxMiguel <- ggplot(datosMiguel, aes(fecha, AccX)) +
  geom_line()
gyMiguel <- ggplot(datosMiguel, aes(fecha, AccX)) +
  geom_line()
gzMiguel <- ggplot(datosMiguel, aes(fecha, AccX)) +
  geom_line()
```

## Gráfica X, Y y Z número 1

```{r}
#| fig-height: 7
(gxSofia / gySofia / gzSofia)
```

## Gráfica X, Y y Z número 2

```{r}
#| fig-height: 7
(gxMelany / gyMelany / gzMelany)
```

## Gráfica X, Y y Z número 3

```{r}
#| fig-height: 7
(gxJuan / gyJuan / gzJuan)
```

## Gráfica X, Y y Z número 4

```{r}
#| fig-height: 7
(gxMiguel / gyMiguel / gzMiguel)
```

```{r}
# Gráfico para eje X
gxConjunta <- ggplot() +
  geom_line(data = datosMelany, aes(x = fecha, y = AccX, color = "Melany")) +
  geom_line(data = datosJuan, aes(x = fecha, y = AccX, color = "Juan")) +
  labs(title = "Aceleración en el eje X", x = "Fecha", y = "AccX", color = "Persona") +
  theme_minimal()

# Gráfico para eje Y
gyConjunta <- ggplot() +
  geom_line(data = datosMelany, aes(x = fecha, y = AccY, color = "Melany")) +
  geom_line(data = datosJuan, aes(x = fecha, y = AccY, color = "Juan")) +
  labs(title = "Aceleración en el eje Y", x = "Fecha", y = "AccY", color = "Persona") +
  theme_minimal()

# Gráfico para eje Z
gzConjunta <- ggplot() +
  geom_line(data = datosMelany, aes(x = fecha, y = AccZ, color = "Melany")) +
  geom_line(data = datosJuan, aes(x = fecha, y = AccZ, color = "Juan")) +
  labs(title = "Aceleración en el eje Z", x = "Fecha", y = "AccZ", color = "Persona") +
  theme_minimal()
```

## Gráfica grabación en conjunto

Las grabaciones que se realizaron en conjunto fueron la número 2 y 3

```{r}
gxConjunta / gyConjunta / gzConjunta
```

### Gráfica de la aceleración total.

$$
AccT = \sqrt{AccX^2 + AccY^2 + AccZ^2}
$$

```{r}
ggplot(datosSofia, aes(fecha, AccT)) +
  geom_line()

ggplot(datosMelany, aes(fecha, AccT)) +
  geom_line()

ggplot(datosJuan, aes(fecha, AccT)) +
  geom_line()

ggplot(datosMiguel, aes(fecha, AccT)) +
  geom_line()
```

\newpage

### Gráfica con una sección de la aceleración total.

```{r}
datosMiguelP <- datosMiguel |> 
  filter(fecha > as.POSIXct("2025-05-06 09:20:00") &
         fecha < as.POSIXct("2025-05-06 09:20:10"))
```

```{r}
ggplot(datosMiguelP, aes(fecha, AccT)) +
  geom_line()
```

```{r}
ggplot(datosMiguelP |> na.omit(), aes(fecha, AccT)) +
  geom_line()
```

\newpage

## Resumen de todos los datos de aceleración

```{r}
summary(datosSofia)

summary(datosMelany)

summary(datosJuan)

summary(datosMiguel)
```

## Análisis exploratorio de los datos
```{r}
datosMelany |>
  summarise(
    mediaX = mean(AccX, na.rm = TRUE),
    sdX = sd(AccX, na.rm = TRUE),
    mediaY = mean(AccY, na.rm = TRUE),
    sdY = sd(AccY, na.rm = TRUE),
    mediaZ = mean(AccZ, na.rm = TRUE),
    sdZ = sd(AccZ, na.rm = TRUE),
    mediaT = mean(AccT, na.rm = TRUE),
    sdT = sd(AccT, na.rm = TRUE)
  )
```

## Identificación actividad
### Identificación cambio de actividad
Antes de identificar el tipo de actividad que se está realizando en cierto momento,
es crucial reconocer el cuando ocurren estos cambios.

Para esto se propone una detección de cambios en la varianza de la aceleración total (AccT) usando ventanas móviles dado que cada actividad (caminar, estar quieto, montar en bus) genera un patrón distinto de variabilidad en la aceleración.

#### Suavizar los datos antes del análisis
Aplicamos una media móvil para suavizar AccT y reducir ruido:

```{r}
# Para no afectar el calculo de la media por los NAs, se llenan con el valor anterior
datosMelany$AccT_sinNA <- na.locf(datosMelany$AccT, na.rm = FALSE)  # forward fill
datosMelany$AccT_suavizada <- rollmean(datosMelany$AccT_sinNA, k = 20, fill = NA, align = "right")

```

```{r}
datosMelany$AccT_suavizada <- rollmean(datosMelany$AccT_sinNA, k = 20,fill = NA, align = "right")
```


#### Calcular diferencia entre segmentos 
```{r}
# Agrupamos
datosMelany <- datosMelany %>%
  mutate(grupo = cut(as.POSIXct(fecha), breaks = "120 sec"))

# Calculamos media y varianza por grupo
resumen <- datosMelany %>%
  group_by(grupo) %>%
  summarise(
    media = mean(AccT_suavizada, na.rm = TRUE),
    varianza = var(AccT_suavizada, na.rm = TRUE),
    rango = max(AccT_suavizada, na.rm = TRUE) - min(AccT_suavizada, na.rm = TRUE),
    tiempo = first(fecha)
  ) %>%
  ungroup()

```

#### Detectar cambios entre grupos
```{r}

resumen$deltaMedia <- c(NA, abs(diff(resumen$media)))
resumen$deltaVar   <- c(NA, abs(diff(resumen$varianza)))
resumen$deltaRango <- c(NA, abs(diff(resumen$rango)))

resumen$cambio <- #resumen$deltaMedia > 1.65 | 
                  resumen$deltaVar > 3 | 
                  resumen$deltaRango > 10
# Valores elegidos con el comportamiento de las respectivas variables

```

```{r}

dotchart(resumen$deltaVar)
dotchart(resumen$deltaRango)
```



#### Gráfica
```{r}
ggplot(datosMelany, aes(x = fecha, y = AccT)) +
  geom_line(color = "steelblue") +
  geom_vline(data = resumen %>% filter(cambio),
             aes(xintercept = as.numeric(tiempo)),
             color = "red", size = 1, linetype = "dashed") +
  labs(title = "Cambios de Actividad (Mejor Detectados)",
       x = "Tiempo", y = "Aceleración Total (AccT)") +
  theme_minimal(base_size = 14)

```

